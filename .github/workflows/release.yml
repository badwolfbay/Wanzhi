name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'  # 触发条件: 推送版本标签 (例如 v1.0.0)

permissions:
  contents: write  # 允许创建 release 和上传文件

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
        
    - name: Restore dependencies
      run: dotnet restore Wanzhi.sln
      
    - name: Build Portable (Framework-Dependent)
      run: dotnet publish Wanzhi/Wanzhi.csproj -c Release -r win-x64 --self-contained false -p:PublishSingleFile=true -p:IncludeNativeLibrariesForSelfExtract=true -p:IncludeAllContentForSelfExtract=true -p:DebugType=None -p:DebugSymbols=false -o publish_framework

    - name: Build Portable (Self-Contained)
      run: dotnet publish Wanzhi/Wanzhi.csproj -c Release -r win-x64 --self-contained true -p:PublishSingleFile=false -p:DebugType=None -p:DebugSymbols=false -o publish_selfcontained

    - name: Build TrayHost (Framework-Dependent)
      run: dotnet publish Wanzhi.TrayHost/Wanzhi.TrayHost.csproj -c Release -r win-x64 --self-contained false -p:PublishSingleFile=true -p:DebugType=None -p:DebugSymbols=false -o publish_tray

    - name: Build Installer Payload
      run: dotnet publish Wanzhi/Wanzhi.csproj -c Release -r win-x64 --self-contained false -p:PublishSingleFile=true -p:IncludeNativeLibrariesForSelfExtract=true -p:IncludeAllContentForSelfExtract=true -p:DebugType=None -p:DebugSymbols=false -o publish

    - name: Merge TrayHost into payload
      run: |
        Copy-Item -Path publish_tray\* -Destination publish\ -Recurse -Force
      shell: pwsh
      
    - name: Create portable packages
      run: |
        $version = "${{ github.ref_name }}"
        Compress-Archive -Path publish_framework\* -DestinationPath "Wanzhi_${version}_Portable_NoRuntime.zip"
        Compress-Archive -Path publish_selfcontained\* -DestinationPath "Wanzhi_${version}_Portable_WithRuntime.zip"
      shell: pwsh
      
    - name: Install Inno Setup
      run: choco install innosetup -y
      shell: pwsh
      
    - name: Update Inno Setup script version
      run: |
        $version = "${{ github.ref_name }}" -replace '^v', ''
        $issContent = Get-Content "Wanzhi\WanzhiSetup.iss" -Raw
        $issContent = $issContent -replace '#define MyAppVersion ".*"', "#define MyAppVersion `"$version`""
        Set-Content "Wanzhi\WanzhiSetup.iss" -Value $issContent
      shell: pwsh
      
    - name: Build installer with Inno Setup
      run: |
        $version = "${{ github.ref_name }}" -replace '^v', ''
        & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" "Wanzhi\WanzhiSetup.iss"
        # Rename output file to include version
        Move-Item "Installer\WanzhiSetup_*.exe" "WanzhiSetup_$version.exe"
      shell: pwsh
      
    - name: Get version from tag
      id: get_version
      run: |
        $version = "${{ github.ref_name }}" -replace '^v', ''
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
      shell: pwsh
      
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: 万枝 ${{ github.ref_name }} - Release
        body: |
          # 万枝 ${{ github.ref_name }}

          ## 🆕 1.2.4 更新

          - 增加显示完整版诗词的选项
          - tray-host + worker架构下优化内存占用           

          ## 🆕 1.2.3 更新

          - 优化深色/浅色模式显示效果：深色模式下壁纸在背景色与效果背景基础上更适配深色
          - 深色模式下诗词与相关文字使用白色显示，提升对比度

          ## 🆕 1.2.2 更新
          
          - 可以设置在右侧显示传统色名称          
          
          ## 🆕 1.2.1 更新
          
          - 新增背景效果：圆泡（Bubbles）
          - 新增背景效果：软团（Blobs）
          - 可在设置中切换不同背景效果
          
          ## 📦 下载
          
          ### 安装包版 (推荐)
          - **文件**: `WanzhiSetup_*.exe`
          - 标准 Windows 安装程序
          - 自动配置，一键安装
          
          ### 便携版
          - **不带运行库**: `Wanzhi_${{ github.ref_name }}_Portable_NoRuntime.zip`
            - 体积更小
            - 需要安装 [.NET 8.0 Desktop Runtime](https://dotnet.microsoft.com/download/dotnet/8.0)
          - **包含运行库**: `Wanzhi_${{ github.ref_name }}_Portable_WithRuntime.zip`
            - 解压即用，无需额外安装运行库
          
          ## ✨ 主要特性
          
          - 🎨 精美的波浪动画背景
          - 🫧 圆泡背景效果（新增）
          - 🧊 软团背景效果（新增）
          - 📜 每日诗词自动更新
          - 🎭 支持竖排/横排双向排版
          - 🌈 自定义背景色和波浪色
          - 🖋️ 字体和字号自由调整
          
          ## 🚀 快速开始
          
          **安装包版**:
          1. 下载并运行 `WanzhiSetup_*.exe`
          2. 按照向导完成安装
          3. 运行万枝
          
          **便携版**:
          1. 下载并解压 ZIP 文件
          2. 运行 `Wanzhi.exe`
          3. 右键托盘图标 → 设置
          
          ---
          
          完整文档: [README.md](https://github.com/${{ github.repository }}/blob/main/README.md)
        files: |
          Wanzhi_${{ github.ref_name }}_Portable_NoRuntime.zip
          Wanzhi_${{ github.ref_name }}_Portable_WithRuntime.zip
          WanzhiSetup_*.exe
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
