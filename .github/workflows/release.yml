name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'  # 触发条件: 推送版本标签 (例如 v1.0.0)

permissions:
  contents: write  # 允许创建 release 和上传文件

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
        
    - name: Restore dependencies
      run: dotnet restore Wanzhi.sln
      
    - name: Build Portable (Framework-Dependent)
      run: dotnet publish Wanzhi/Wanzhi.csproj -c Release -r win-x64 --self-contained false -p:PublishSingleFile=true -p:IncludeNativeLibrariesForSelfExtract=true -p:IncludeAllContentForSelfExtract=true -p:DebugType=None -p:DebugSymbols=false -o publish_framework

    - name: Build Portable (Self-Contained)
      run: dotnet publish Wanzhi/Wanzhi.csproj -c Release -r win-x64 --self-contained true -p:PublishSingleFile=false -p:DebugType=None -p:DebugSymbols=false -o publish_selfcontained

    - name: Build TrayHost (Framework-Dependent)
      run: dotnet publish Wanzhi.TrayHost/Wanzhi.TrayHost.csproj -c Release -r win-x64 --self-contained false -p:PublishSingleFile=true -p:DebugType=None -p:DebugSymbols=false -o publish_tray

    - name: Build TrayHost (Self-Contained)
      run: dotnet publish Wanzhi.TrayHost/Wanzhi.TrayHost.csproj -c Release -r win-x64 --self-contained true -p:PublishSingleFile=false -p:DebugType=None -p:DebugSymbols=false -o publish_tray_selfcontained

    - name: Merge TrayHost into portable packages
      run: |
        Copy-Item -Path publish_tray\* -Destination publish_framework\ -Recurse -Force
        Copy-Item -Path publish_tray_selfcontained\* -Destination publish_selfcontained\ -Recurse -Force
      shell: pwsh

    - name: Build Installer Payload
      run: dotnet publish Wanzhi/Wanzhi.csproj -c Release -r win-x64 --self-contained false -p:PublishSingleFile=true -p:IncludeNativeLibrariesForSelfExtract=true -p:IncludeAllContentForSelfExtract=true -p:DebugType=None -p:DebugSymbols=false -o publish

    - name: Merge TrayHost into payload
      run: |
        Copy-Item -Path publish_tray\* -Destination publish\ -Recurse -Force
      shell: pwsh
      
    - name: Create portable packages
      run: |
        $version = "${{ github.ref_name }}"
        Compress-Archive -Path publish_framework\* -DestinationPath "Wanzhi_${version}_Portable_NoRuntime.zip"
        Compress-Archive -Path publish_selfcontained\* -DestinationPath "Wanzhi_${version}_Portable_WithRuntime.zip"
      shell: pwsh
      
    - name: Install Inno Setup
      run: choco install innosetup -y
      shell: pwsh
      
    - name: Update Inno Setup script version
      run: |
        $version = "${{ github.ref_name }}" -replace '^v', ''
        $issContent = Get-Content "Wanzhi\WanzhiSetup.iss" -Raw
        $issContent = $issContent -replace '#define MyAppVersion ".*"', "#define MyAppVersion `"$version`""
        Set-Content "Wanzhi\WanzhiSetup.iss" -Value $issContent
      shell: pwsh
      
    - name: Build installer with Inno Setup
      run: |
        $version = "${{ github.ref_name }}" -replace '^v', ''
        & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" "Wanzhi\WanzhiSetup.iss"
        # Rename output file to include version
        Move-Item "Installer\WanzhiSetup_*.exe" "WanzhiSetup_$version.exe"
      shell: pwsh
      
    - name: Get version from tag
      id: get_version
      run: |
        $version = "${{ github.ref_name }}" -replace '^v', ''
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
      shell: pwsh
      
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: 万枝 ${{ github.ref_name }} - Release
        generate_release_notes: true
        files: |
          Wanzhi_${{ github.ref_name }}_Portable_NoRuntime.zip
          Wanzhi_${{ github.ref_name }}_Portable_WithRuntime.zip
          WanzhiSetup_*.exe
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
