name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'  # è§¦å‘æ¡ä»¶: æ¨é€ç‰ˆæœ¬æ ‡ç­¾ (ä¾‹å¦‚ v1.0.0)

permissions:
  contents: write  # å…è®¸åˆ›å»º release å’Œä¸Šä¼ æ–‡ä»¶

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
        
    - name: Restore dependencies
      run: dotnet restore Wanzhi/Wanzhi.csproj
      
    - name: Build Portable (Framework-Dependent)
      run: dotnet publish Wanzhi/Wanzhi.csproj -c Release -r win-x64 --self-contained false -p:PublishSingleFile=true -o publish_framework

    - name: Build Portable (Self-Contained)
      run: dotnet publish Wanzhi/Wanzhi.csproj -c Release -r win-x64 --self-contained true -p:PublishSingleFile=true -o publish_selfcontained
      
    - name: Create portable packages
      run: |
        $version = "${{ github.ref_name }}"
        Compress-Archive -Path publish_framework\* -DestinationPath "Wanzhi_${version}_Portable_NoRuntime.zip"
        Compress-Archive -Path publish_selfcontained\* -DestinationPath "Wanzhi_${version}_Portable_WithRuntime.zip"
      shell: pwsh
      
    - name: Install Inno Setup
      run: choco install innosetup -y
      shell: pwsh
      
    - name: Update Inno Setup script version
      run: |
        $version = "${{ github.ref_name }}" -replace '^v', ''
        $issContent = Get-Content "Wanzhi\WanzhiSetup.iss" -Raw
        $issContent = $issContent -replace '#define MyAppVersion ".*"', "#define MyAppVersion `"$version`""
        Set-Content "Wanzhi\WanzhiSetup.iss" -Value $issContent
      shell: pwsh
      
    - name: Build installer with Inno Setup
      run: |
        $version = "${{ github.ref_name }}" -replace '^v', ''
        & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" "Wanzhi\WanzhiSetup.iss"
        # Rename output file to include version
        Move-Item "Installer\WanzhiSetup_*.exe" "WanzhiSetup_$version.exe"
      shell: pwsh
      
    - name: Get version from tag
      id: get_version
      run: |
        $version = "${{ github.ref_name }}" -replace '^v', ''
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
      shell: pwsh
      
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: ä¸‡æ ${{ github.ref_name }} - Release
        body: |
          # ä¸‡æ ${{ github.ref_name }}
          
          ## ğŸ“¦ ä¸‹è½½
          
          ### å®‰è£…åŒ…ç‰ˆ (æ¨è)
          - **æ–‡ä»¶**: `WanzhiSetup_*.exe`
          - æ ‡å‡† Windows å®‰è£…ç¨‹åº
          - è‡ªåŠ¨é…ç½®ï¼Œä¸€é”®å®‰è£…
          
          ### ä¾¿æºç‰ˆ
          - **ä¸å¸¦è¿è¡Œåº“**: `Wanzhi_${{ github.ref_name }}_Portable_NoRuntime.zip`
            - ä½“ç§¯æ›´å°
            - éœ€è¦å®‰è£… [.NET 8.0 Desktop Runtime](https://dotnet.microsoft.com/download/dotnet/8.0)
          - **åŒ…å«è¿è¡Œåº“**: `Wanzhi_${{ github.ref_name }}_Portable_WithRuntime.zip`
            - è§£å‹å³ç”¨ï¼Œæ— éœ€é¢å¤–å®‰è£…è¿è¡Œåº“
          
          ## âœ¨ ä¸»è¦ç‰¹æ€§
          
          - ğŸ¨ ç²¾ç¾çš„æ³¢æµªåŠ¨ç”»èƒŒæ™¯
          - ğŸ“œ æ¯æ—¥è¯—è¯è‡ªåŠ¨æ›´æ–°
          - ğŸ­ æ”¯æŒç«–æ’/æ¨ªæ’åŒå‘æ’ç‰ˆ
          - ğŸŒˆ è‡ªå®šä¹‰èƒŒæ™¯è‰²å’Œæ³¢æµªè‰²
          - ğŸ–‹ï¸ å­—ä½“å’Œå­—å·è‡ªç”±è°ƒæ•´
          
          ## ğŸš€ å¿«é€Ÿå¼€å§‹
          
          **å®‰è£…åŒ…ç‰ˆ**:
          1. ä¸‹è½½å¹¶è¿è¡Œ `WanzhiSetup_*.exe`
          2. æŒ‰ç…§å‘å¯¼å®Œæˆå®‰è£…
          3. è¿è¡Œä¸‡æ
          
          **ä¾¿æºç‰ˆ**:
          1. ä¸‹è½½å¹¶è§£å‹ ZIP æ–‡ä»¶
          2. è¿è¡Œ `Wanzhi.exe`
          3. å³é”®æ‰˜ç›˜å›¾æ ‡ â†’ è®¾ç½®
          
          ---
          
          å®Œæ•´æ–‡æ¡£: [README.md](https://github.com/${{ github.repository }}/blob/main/README.md)
        files: |
          Wanzhi_${{ github.ref_name }}_Portable_NoRuntime.zip
          Wanzhi_${{ github.ref_name }}_Portable_WithRuntime.zip
          WanzhiSetup_*.exe
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
